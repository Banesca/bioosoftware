(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{wgpX:function(e,t,r){"use strict";r.d(t,"a",(function(){return p}));var i=r("AytR"),s=r("PSD3"),o=r.n(s),a=r("5JmO"),n=r("TruH"),d=r("Kj3r"),l=r("pLZG"),c=r("eIep"),h=r("JIr8"),u=r("XNiG"),m=r("LRne");class p{constructor(e,t,r,s,o,a,n,d,l,c,h,m,p,b,v,S,g,_){this._modalService=e,this._adminService=t,this._familyService=r,this._ordenService=s,this._formBuilder=o,this._productService=a,this._tableService=n,this._discountService=d,this._authService=l,this._router=c,this._sweetAlertsService=h,this._paramsService=m,this._clientsService=p,this._taxesService=b,this._billingBoxService=v,this._ngbDropdownConfig=S,this._walletService=g,this.calendar=_,this.totalSumProducts=0,this.seleccionados=[],this.con_sin=!0,this.totalAux=0,this.families=[],this.loading=!0,this.productIdDelete=null,this.table=null,this.idBranch=localStorage.getItem("idBranchFk"),this.modalidad="",this.valorPensable="",this.productos=[],this.orden={},this.list=!1,this.onOps=!1,this.edit=!1,this.urlImgProduct=i.a.apiHost+"/product/",this.urlImgFamily=i.a.apiHost+"/family/",this.band=!1,this.bandPaid=!1,this.productsMitad=[],this.bandCreate=!1,this.productsM={},this.i=1,this.showExtraList=!1,this.realDiscount=!1,this.discounts=[],this.fromWeb=null,this.extraWeb=0,this.extrasValue=0,this.auxTotalPorProducto=0,this.discountFromWeb=0,this.beforeDiscount=0,this.TOTAL=0,this.TOTAL_PRODUCTOS=0,this.TOTAL_SUBTOTAL=0,this.TOTAL_PRODUCTOS_ADICIONALES=0,this.TOTAL_ENVIO=0,this.TOTAL_COMISION=0,this.TOTAL_DESCUENTO=0,this.dropdownSettings={},this.clients=[],this.select="",this.dolarRate=0,this.newClient=!1,this.taxes=[],this.productsToKitchen=[],this.multiProductsFlag=!1,this.creditNoteArr=[],this.bodyList=[],this.myDate=this.calendar.getToday(),this.producto="",this.kilogramos=null,this.clientSubject=new u.a}get g(){return this.formUpdate.controls}get myFormGetter(){return this.myForm.controls}handleKeyboardEvent(e){switch(e.keyCode){case 4:e.preventDefault(),this.openPaid(this.child,!1);break;case 13:e.preventDefault(),this.orden.facturaAfip&&this.openPaid(this.child,!1);break;case 112:e.preventDefault(),this.reprintCocina(this.orden.idOrderH);break;case 113:e.preventDefault(),this.openPaid(this.child,!0,"FACTURAR",1);break;case 114:e.preventDefault(),this.reprint(this.orden.idOrderH);break;case 115:e.preventDefault(),this.closeOrder();break;case 116:e.preventDefault(),this.openPassword(this.passwordModaleChild,0,4);break;case 117:e.preventDefault(),this.transferirOrden();break;case 118:e.preventDefault(),this.openPaid(this.child,!1,"CERRAR",2);break;case"+58"==this.phonePrefix?119:"":e.preventDefault(),this.openSeniat(this.seniatModaleChild);break;case"+58"==this.phonePrefix?120:119:e.preventDefault(),1==this.refundReprintAuth?this.openPassword(this.passwordModaleChild,"",9):this.confirmKitchenAndPrint(this.orden.idOrderH);break;case"+58"==this.phonePrefix?121:120:e.preventDefault(),this.pricePDF()}}ngOnInit(){this.getDiscounts(),this.getTaxes(),this.profile=localStorage.getItem("idProfile"),this.modalidades=[{name:"Delivery/Tienda",value:"deliveryEnTienda"},{name:"Take Away",value:"deliveryEnLocal"},{name:"Delivery externo",value:"deliveryExterno"},{name:"Consumo en el local",value:"consumoEnLocal"}],this._ordenService.dicount=0,this._adminService.module="orden",this._ordenService.platesSelected=[],this.getFamilies(),this.getUser(),this.formUpdate=this._formBuilder.group({price:""}),this.formObservation=this._formBuilder.group({observation:""}),this.formPensable=this._formBuilder.group({pensable:[1]}),this.form=this.getFormBuilder(),this.myForm=this.getMyFormBuilder(),this.getProducts(),this.getParams(),this._clientsService.getClientes().subscribe(({response:e})=>{this.clients=e}),this.dropdownSettings={singleSelection:!0,idField:"phoneClient",textField:"fullNameClient",itemsShowLimit:8,allowSearchFilter:!0,closeDropDownOnSelection:!0,clearSearchFilter:!0,enableCheckAll:!1,noDataAvailablePlaceholderText:"No se encontraron productos",searchPlaceholderText:"Buscar producto"},this._ngbDropdownConfig.placement="top-start",this.form.get("busqueda").valueChanges.pipe(Object(d.a)(180)).subscribe(e=>{this.buscarProductoPorId(e)}),this.debounceClientInformation()}ngAfterViewInit(){this.searchInput.nativeElement.focus()}getParams(){this._paramsService.GetParam().subscribe(({response:e})=>{this.deleteAuth=e[56].param,this.dolarRate=+e[52].param,this.phonePrefix=e[50].param,this.refundReprintAuth=e[62].param,this.registerMovementCurrentAccAndAccPayable=e[72].param,this.iva16=e[89].param,this.maxDiscount=e[70].param},()=>{this._sweetAlertsService.alertoast("Error al obtener par\xe1metros.","error")})}getFormBuilder(){return this._formBuilder.group({busqueda:[""]})}getMyFormBuilder(){return this._formBuilder.group({client:[""],phoneClient:[""],address:[""],document:[""],comments:[""],referencia:[""]})}getProducts(){this._productService.GetProductsByTypeFilter(1).subscribe(e=>{null!=e&&(this.productos=e.data,this.productsMitad=this.productos.filter(e=>"1"===e.is5050),this.getOrden(!1))})}clientInformation(e){let t=e.target.value;this.clientSubject.next(t)}debounceClientInformation(){this.clientSubject.pipe(Object(l.a)(e=>e.length>5),Object(d.a)(700),Object(c.a)(e=>this._ordenService.getClientInformation({query:e}).pipe(Object(h.a)(e=>(this._sweetAlertsService.alertoast("Error al buscar el cliente","error"),Object(m.a)(null)))))).subscribe(e=>{e?(this._sweetAlertsService.alertoast("Cliente encontrado","success"),this.changeClientInformation(e.data)):this._sweetAlertsService.alertoast("Cliente no encontrado","error")})}changeClientInformation(e){this.myFormGetter.client.setValue(e.fullNameClient),this.myFormGetter.phoneClient.setValue(e.phoneClient),this.myFormGetter.address.setValue(e.address),this.myFormGetter.document.setValue(e.documento),this.myFormGetter.comments.setValue(e.comments),this.myFormGetter.referencia.setValue(e.referencia);const t={fullNameClient:e.fullNameClient,phoneClient:e.phoneClient,address:e.address,nameClient:e.nameClient,comments:e.comments,moso:e.moso,documento:e.documento,referencia:e.referencia};this._ordenService.updateDataClient(this.orden.idOrderH,t).subscribe(e=>{document.getElementById("clientInformation").value="",this.getOrden()})}updateObservationOrder(e){const t={observation:this.formObservation.controls.observation.value};this._ordenService.updateObservationOrder(e,t).subscribe(e=>{this._sweetAlertsService.alertoast("Observaci\xf3n guardada.","success")})}calKilogramos(){const e={idOrderB:this._ordenService.platesSelected[this._ordenService.platesSelected.length-1].idOrderB,weight:this.kilogramos};this._ordenService.updateWeigthByProduct(e).subscribe(e=>{this.recarga(),this.kilogramos=0},e=>{this._sweetAlertsService.alertoast("No se pudo actualizar la unidad.","error")})}calPensable(e,t){if(this.loading=!0,this.formPensable.controls.pensable.value>=0){const t={idOrderB:e.idOrderB,weight:this.formPensable.controls.pensable.value};this._ordenService.updateWeigthByProduct(t).subscribe(e=>{this._sweetAlertsService.alertoast("Unidad de producto actualizada con \xe9xito.","success"),this.recarga()},e=>{this._sweetAlertsService.alertoast("No se pudo actualizar la unidad.","error"),this.loading=!1})}else this._sweetAlertsService.alertoast("El valor no puede ser cero o menor a cero.","Error")}selectProducts(e,t,r,i,s,o){let a={};1===t&&(a.idProduct1=r),2===t&&(a.idProduct2=r),this._ordenService.updateIdProducts(a,i).subscribe(e=>{this.getOrden(!0)})}isCurrentAccount(){this._ordenService}updateTotal(){const e={totalBot:this.g.price.value};this._ordenService.updateTotal(e,this._adminService.orderId).subscribe(e=>{this._sweetAlertsService.alertoast("Precio editado","success")}),this._ordenService.platesSelected.totalAPagar=parseFloat(e.totalBot)}changeMethod(e){const t={deliveryEnTienda:!1,deliveryEnLocal:!1,deliveryExterno:!1,consumoEnLocal:!1,idOrderH:this.orden.idOrderH};for(const[r,i]of Object.entries(t))r===e?t[e]=!0:i===Boolean&&(t[r]=!1);this._ordenService.updateOrder(t).subscribe(e=>{this._sweetAlertsService.alertoast("Modalidad agregada","success")})}getOrden(e){this.loading=!0,this._ordenService.dicount=0,this._ordenService.extraWeb=0,this._adminService.idTable||this._adminService.orderId?(!this.table&&this._adminService.idTable&&(this.table=this._adminService.idTable),this._adminService.idTable=null,(this._adminService.orderId?this._adminService.orderId:this.table.order[0]&&this.table.order[0].idOrderH)?this._ordenService.GetOrder(this._adminService.orderId?this._adminService.orderId:this.table.order[0].idOrderH).subscribe(e=>{this.orden=e.data,this.bodyList=e.data.body?e.data.body:[];let t=0;if(void 0!==this.orden.body&&this.orden.body.length>0&&this.orden.body.forEach(e=>{e.listSinCon.length>0&&e.listSinCon.forEach(e=>{t+=e.priceSale}),t+=e.priceProductOrder}),this.fromWeb=e.data.isFromWeb,this.extraWeb=e.data.totalBot,this._adminService.orderStatus=this.orden.statusOrder,this._ordenService.platesSelected=e.data.body,this._adminService.orderId=this._adminService.orderId?this._adminService.orderId:this.table.order[0].idOrderH,this._adminService.idUserOpenOrder=this.orden.idUserOpenFk,this._ordenService.userId=this.user,this._ordenService.extraWeb=this.orden.extraWeb,this._ordenService.platesSelected&&this._ordenService.platesSelected.length){this._ordenService.platesSelected.totalAPagar=0;for(let t=0;t<e.data.body.length;++t)this.orden.discount&&0==this.orden.discount&&(this.orden.discountTotal=0),this._productService.GetProduct(this._ordenService.platesSelected[t].idProductFk).subscribe(e=>{this._ordenService.platesSelected.find(t=>t.idProductFk==e.data.idProduct).adicionals=e.data.adicionals})}this.bandCreate&&this.changeMethod("consumoEnLocal"),this.loading=!0,setTimeout(()=>{this._ordenService.getTotalesByOrden(this._adminService.orderId?this._adminService.orderId:this.table.order[0].idOrderH).subscribe(({message:e})=>{this.TOTAL=e[0].TOTAL_CONDESCUENTO,this.TOTAL_PRODUCTOS=e[0].TOTAL_PRODUCTOS,this.TOTAL_PRODUCTOS_ADICIONALES=e[0].TOTAL_PRODUCTOS_ADICIONALES,this.TOTAL_COMISION=e[0].TOTAL_COMISION,this.TOTAL_DESCUENTO=e[0].TOTAL_DESCUENTO,this.TOTAL_SUBTOTAL=e[0].TOTAL_SUBTOTAL,this.loading=!1,null==this.orden.body?t=this.TOTAL:t+=(null!=this.orden.envio?this.orden.envio:0)-(null!=this.orden.discountAmount?this.orden.discountAmount:0),this.totalSumProducts=t},()=>{this._sweetAlertsService.alertoast("Error al obtener totales.","error")})},700),this.kilogramos&&this.calKilogramos()},e=>{this._sweetAlertsService.alertoast("No se puedieron obtener los datos de la orden","error"),this.loading=!0}):this.newOrder(this.table.idTable,this.user,this.idBranch)):null!=this._adminService.idTableX?this.newOrder(this._adminService.idTableX,this.user,this.idBranch):this.newOrderFree()}putMethodsOrder(){}newOrderFree(){this.getFamilies(),this.table=null,this._ordenService.userId=this.user,this.newOrder(this.table,this.user,this.idBranch)}newOrder(e,t,r){this._adminService.idUserOpenOrder=t;const i=localStorage.getItem("phoneClient");let s=localStorage.getItem("document"),o="";o="Generico"===this._adminService.client?this._adminService.client:localStorage.getItem("nameClient"),null==e&&(e=0),this.myForm.reset();const a={idTableFk:e,idUserOpenFk:parseInt(localStorage.getItem("idUser")),fullNameClient:o,documento:s||("+58"==this.phonePrefix?"V-0000000":""),phoneClient:i||null,idBranchFk:r,moso:localStorage.getItem("moso")?localStorage.getItem("moso"):null,deliveryEnTienda:!1,deliveryEnLocal:!1,deliveryExterno:!1,address:0!=e?"MESA: "+(null!=this._adminService.idTableX?this._adminService.numberTable:this.table.numberTable):localStorage.getItem("address"),comments:localStorage.getItem("observation")?localStorage.getItem("observation"):"",idEnvironmentFk:localStorage.getItem("idEnvironmet"),isPointOfSales:1};this._ordenService.NewOrder(a).subscribe(e=>{this._sweetAlertsService.alertoast("Orden Creada","success"),this._adminService.orderId=e.data[0],localStorage.removeItem("observation"),localStorage.removeItem("moso"),this._adminService.client="",this.bandCreate=!1,this.getOrden(!1)},e=>{this._sweetAlertsService.alertoast("La orden no pudo ser creada","error")})}closeOrder(){o.a.fire({title:"Enviar a cuentas por cobrar?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#41d29d",cancelButtonColor:"#f96767",cancelButtonText:"Cancelar",confirmButtonText:"Confirmar"}).then(e=>{e.value&&this._ordenService.CloseOrder(this.orden.idOrderH,{isacountCourrient:!0}).subscribe(e=>{this._ordenService.updateTotal({totalBot:+this.orden.totalBot},this.orden.idOrderH).subscribe(e=>{const t={title:this.orden.comments,amount:this.TOTAL,idUserAddFk:this.orden.fullname,isEntry:0,idClientFk:this.orden.phoneClient,idBranchFk:this.idBranch,idCurrencyFk:1,idPaymentMethodFk:13,idOrder:this.orden.idOrderH};this._walletService.NewWallet(t).subscribe(e=>{this._adminService.orderId=null,this._adminService.idTable=null,o.a.fire("Orden enviada a cuentas por cobrar.","","success").then(e=>{this._router.navigate(["/admin/mesas/pedidos"])})},e=>{console.log("Error code: newW",e)})})},e=>{this._sweetAlertsService.alertoast("No se pud\xf3 completar el cierre de la orden la orden","error")})})}getUser(){this._authService.getAuthUser().subscribe(e=>{this.user=parseInt(localStorage.getItem("idUser"))})}onEnter(){}getFamilies(){this._familyService.GetFamilies().subscribe(e=>{this.families=e.response,this._router.navigate(["/admin/puntoDeVenta/platos",this.families[0].idProductFamily])},e=>{this._sweetAlertsService.alertoast("No se puedieron obtener los datos del menu","error")})}openModal(e,t,r){this.product=this._ordenService.platesSelected[t],this.con_sin=r,this.modalRef=this._modalService.open(e,{size:"lg",backdrop:"static"})}deleteOfOrder(e){if(this.loading=!0,"Cerrada"!=this.orden.statusOrder){const t={totalBot:parseFloat(this._ordenService.platesSelected.totalAPagar)-this._ordenService.platesSelected[e].totalPrice};this._ordenService.updateTotal(t,this.orden.idOrderH).subscribe(t=>{this._ordenService.DeleteProductOfOrder(this._ordenService.platesSelected[e].idOrderB,this.user).subscribe(t=>{this._ordenService.DeletePlate(e),this.getOrden(!0),this.orden.discountTotal=0==this._ordenService.dicount?this.orden.discountTotal:this._ordenService.dicount})})}}paidOrder(e){let t;this._ordenService.platesSelected&&(t=this.orden.discountTotal?(this._ordenService.platesSelected.totalAPagar-this.orden.discountTotal).toFixed(2):this._ordenService.platesSelected.totalAPagar.toFixed(2))}anularOrden(){"Cerrada"!=this.orden.statusOrder&&o.a.fire({title:"\xbfEst\xe1 seguro que quiere anular la orden?",text:"No podr\xe1 revertir esta acci\xf3n.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#459f47",cancelButtonColor:"#f96767",cancelButtonText:"Cancelar",confirmButtonText:"S\xed, Anular"}).then(e=>{e.value&&this._ordenService.CancelOrder(this.orden.idOrderH).subscribe(e=>{this._ordenService.CancelOrder(this.orden.idOrderH).subscribe(e=>{if("0"==this.registerMovementCurrentAccAndAccPayable&&"1"==this.orden.isacountCourrient){const e={amount:this.orden.totalBot-this.orden.discountAmount+(null!=this.orden.discountAmount?this.orden.discountAmount:0),idBranchFk:this.idBranch,idClientFk:this.orden.phoneClient,idOrder:this.orden.idOrderH+" Anulada.",idPaymentMethodFk:13,idUserAddFk:parseInt(localStorage.getItem("idUser")),isEntry:1,nameClient:this.orden.fullNameClient,title:"Anulaci\xf3n orden:"+this.orden.idOrderH};this._walletService.NewWallet(e).subscribe()}o.a.fire("Anulada!","La orden ha sido anulada.","success").then(e=>{this._adminService.orderId=null,this._adminService.idUserOpenOrder=null,this._adminService.idTable=null,this.getFamilies(),this.newOrderFree()})},e=>{this._sweetAlertsService.alertoast("No se pud\xf3 cancelar la orden","error")})},e=>{this._sweetAlertsService.alertoast("No se pud\xf3 cancelar la orden","error")})})}transferirOrden(){if("Cerrada"==this.orden.statusOrder)return;let e={idOrderH:this.orden.idOrderH,idOldTableFk:this.orden.idTableFk?this.orden.idTableFk:null,idNewTableFk:null};this._tableService.getTablesByEnvironmentTwo(localStorage.getItem("idBranchFk")).subscribe(t=>{let r={};for(let e=0;e<t.data.length;++e)0==t.data[e].order.length&&(r[t.data[e].idTable]=t.data[e].numberTable);o.a.fire({title:"\xbfA cual mesa desea mover esta orden?",input:"select",inputPlaceholder:"Seleccione la mesa",inputAttributes:{autocapitalize:"off"},showLoaderOnConfirm:!0,showCancelButton:!0,confirmButtonColor:"#459f47",cancelButtonColor:"#f96767",cancelButtonText:"Cancelar",confirmButtonText:"Mover",inputOptions:r,inputValidator:t=>{if(!t)return"Necesitas escoger una mesa";e.idNewTableFk=parseInt(t)}}).then(t=>{if(t.value){let i;for(const[e,s]of Object.entries(r))t.value===e&&(i=s);this._ordenService.TransferOrder(e).subscribe(e=>{o.a.fire("Movido con \xe9xito!","Su orden fue movida a la mesa "+i,"success").then(()=>{this._adminService.orderId=null,this._adminService.idUserOpenOrder=null,this._adminService.idTable=null,this.getFamilies(),this.newOrderFree()})},e=>{this._sweetAlertsService.alertoast("No se pud\xf3 trasnferir la orden","error")})}})})}buscarProductoPorId(e){if(e){let t=this.productos.find(t=>t.barCode==e);if(!t){const r=this.obtenerProducto(e);r&&(t=this.productos.find(e=>e.barCode==r),this.kilogramos=this.obtenerKilogramos(e))}t?this.addInOrder(t.idProduct):this._sweetAlertsService.alertoast("Producto no encontrado","error")}}obtenerProducto(e){return e.substring(3,6)}obtenerKilogramos(e){const t=e.substring(7,11);return parseInt(t,10)/1e3}addInOrder(e){this.loading=!0,this.list=!1,this.onOps=!1;let t={};for(let r=0;r<this.productos.length;++r)if(this.productos[r].idProduct==e){t=this.productos[r];break}this.form.controls.busqueda.setValue(""),this.formPensable.controls.pensable.setValue("1"),this._ordenService.AddPlate(t),this._sweetAlertsService.alertoast("Agregado producto con \xe9xito.","success"),this._ordenService.GetOrder(this.orden.idOrderH).subscribe(e=>{this.bodyList=e.data.body,this.recarga()})}openDiscounts(e){this.discountsRef=this._modalService.open(e,{size:"lg",backdrop:"static"})}openPaid(e,t,r=null,i=null){this.textButton=r,0!==this._ordenService.platesSelected.length?null==this.orden.facturaAfip&&"Cancelado"!=this.orden.statusOrder&&(this.paidRef=this._modalService.open(e,{size:"lg",backdrop:"static"}),this.band=t,null!=i&&(this.typeOperacion=i)):this._sweetAlertsService.alertoast("No tiene ning\xfan monto por pagar","error")}openClose(e){this._ordenService.platesSelected?this.paidRef=this._modalService.open(e,{size:"lg",backdrop:"static"}):this._sweetAlertsService.alertoast("No tiene ning\xfan monto por pagar","error")}recarga(e){this.getOrden(!0)}reprint(e){null!=this._ordenService.platesSelected&&0!==this._ordenService.platesSelected.length?this._ordenService.reprint(e).subscribe(e=>{e&&"ok"==e.message&&this._sweetAlertsService.alertoast("Impresion enviada espere unos segundos","success")},()=>{this._sweetAlertsService.alertoast("Ha ocurrido un error.","error")}):this._sweetAlertsService.alertoast("No tiene productos seleccionados","error")}reprintCocina(e){null!=this._ordenService.platesSelected&&0!==this._ordenService.platesSelected.length?this._ordenService.reprintCocina(e).subscribe(e=>{e&&"ok"==e.message&&this._sweetAlertsService.alertoast("Impresion enviada espere unos segundos.","success")},()=>{this._sweetAlertsService.alertoast("Ha ocurrido un error.","error")}):this._sweetAlertsService.alertoast("No tiene productos seleccionados","error")}openPassword(e,t,r){switch(this.actionValidate=r,r){case 1:this.textValidadion=" eliminar el producto";break;case 2:this.textValidadion=" aplicar descuento";break;case 3:this.textValidadion=" aplicar impuesto";break;case 4:this.textValidadion=" anular el pedido";break;case 5:this.textValidadion="reimprimir";break;case 6:this.textValidadion="hacer devoluci\xf3n";break;case 9:this.textValidadion=" enviar a impresi\xf3n a caja y cocina.";break;case 10:this.textValidadion=" emitir nota de credito.";break;case 11:this.textValidadion=" para emitir este tipo de descuento"}this.productIdDelete=t,this.passwordRef=this._modalService.open(e)}getValidate(e){1==this.actionValidate&&0!=e&&this.deleteOfOrder(this.productIdDelete),2!=this.actionValidate&&3!=this.actionValidate||0!=e&&(this.realDiscount=!0),4==this.actionValidate&&0!=e&&this.anularOrden(),5==this.actionValidate&&0!=e&&this.refundFunctionalButton(),6==this.actionValidate&&0!=e&&this.refundFunctionalButton(),7==this.actionValidate&&0!=e&&this.closeOrder(),9==this.actionValidate&&0!=e&&this.confirmKitchenAndPrint(this.orden.idOrderH),10==this.actionValidate&&0!=e&&this.creditNoteCheck(this.orden.idOrderH),11==this.actionValidate&&0!=e&&this.setDiscount(this.tempDiscount),0==e&&this._sweetAlertsService.alertoast("C\xf3digo de autorizaci\xf3n incorrecto.","error")}keyPressNumbers(e){const t=e.which?e.which:e.keyCode;return!(46!=t&&t>31&&(t<48||t>57))||(e.preventDefault(),!1)}sendPrinter(e,t){if(this.multiProductsFlag)this.productsToKitchen.forEach(e=>{const r={idOrderB:e,idOrderH:t};this._ordenService.printerOrder(r).subscribe(()=>{})}),this._sweetAlertsService.alertoast("Impresiones enviadas espere unos segundos.","success");else{const r={idOrderB:e,idOrderH:t};this._ordenService.printerOrder(r).subscribe(e=>{this._sweetAlertsService.alertoast("Impresi\xf3n enviada espere unos segundos.","success")})}}updateAmountSend(e,t){this.loading=!0;let r=document.getElementById("envio").value;if(""!=r){const t={envio:r};this._ordenService.updateAmountSend(e,t).subscribe(e=>{this._sweetAlertsService.alertoast("Envio actualizado","success"),this.recarga()},e=>{this._sweetAlertsService.alertoast("No se ha podido actualizar el envio","error")})}}calItems(e){let t;return t=e.filter(e=>0!=e.isCon),t.length}validate(e){return e.filter(e=>0!=e.isCon)}validateInZero(e){return e.filter(e=>0==e.isCon)}showExtras(e){this.extrasValue=0,this.seleccionados=this.con_sin?e.listSinCon?this.validate(e.listSinCon):[]:e.recipe?this.validateInZero(e.recipe):[],this.seleccionados.totalAdicional=0;for(let t=0;t<this.seleccionados.length;++t){const e=this.seleccionados[t].priceSale*this.seleccionados[t].quantity;this.seleccionados.totalAdicional+=e}this.totalAux=this.seleccionados.totalAdicional,e.listSinCon.forEach(e=>{this.extrasValue+=e.priceSale}),this.showExtra=e.idProductFk,this.showExtraList=!this.showExtraList}addAdditional(e,t){this.loading=!0;const r=e.adicionals.find(e=>e.idProductAdicionals==+t),i={idOrderBFk:e.idOrderB,idProductFk:r.idProductFk,idProductSinConFk:r.idProduct,quantity:1,isCon:!0,price:r.priceSale,idOrderHFk:e.idOrderHFk};this._ordenService.AddAditionalsToTheOrder(i).subscribe(e=>{this.loading=!0,this.seleccionados?(r.idProductRecipeOrder=e.data[0],this.seleccionados.splice(this.seleccionados.length,0,r)):(this.seleccionados=[],r.idProductRecipeOrder=e.data[0],this.seleccionados[0]=r),this.seleccionados.totalAdicional+=r.priceSale,this.recarga()},e=>{this._sweetAlertsService.alertoast("Error al agregar el extra.","error")})}deleteProducts(e,t,r){let i;i=this.con_sin?e.idProductRecipeOrder:e.idProductRecipeFk,this._ordenService.DeleteAditionalsToTheOrder(i).subscribe(r=>{this.seleccionados.totalAdicional-=e.priceSale,this.seleccionados.splice(t,1),this._sweetAlertsService.alertoast("Eliminado con exito","success"),this.recarga()})}getDiscounts(){this._discountService.GetDiscounts().subscribe(e=>{for(let t=0;t<e.response.length;++t)"1"==e.response[t].idStatusFk&&this.discounts.splice(this.discounts.length,0,e.response[t])})}handleDiscount(e){this.maxDiscount>0&&e>this.maxDiscount?(this.tempDiscount=e,this.openPassword(this.passwordModaleChild,"",11)):this.setDiscount(e)}setDiscount(e){(+e||0==+e)&&this._ordenService.AddDiscountToTheOrder(this.orden.idOrderH,0==+e?0:+e).subscribe(t=>{this._ordenService.GetOrder(this.orden.idOrderH).subscribe(t=>{this.recarga(),0==+e?this._sweetAlertsService.alertoast("Descuento eliminado","success"):this._sweetAlertsService.alertoast("Descuento agregado","success")})})}getExtras(e){this.loading=!0,this.allExtras=[],e.adicionals,this._productService.GetProduct(e.idProduct).subscribe(({data:t})=>{this.allExtras=t.adicionals,e.adicionals=t.adicionals,this.loading=!1},e=>{this._sweetAlertsService.alertoast("Error al obtener extras.","error"),this.loading=!0})}onClientSelected(e){const t=this.clients.find(t=>t.phoneClient==e),r={fullNameClient:t.fullNameClient,phoneClient:this.myFormGetter.phoneClient.value||t.phoneClient,address:this.myFormGetter.address.value||t.address,nameClient:t.fullNameClient,comments:this.myFormGetter.comments.value,moso:this.myFormGetter.document.value};this._ordenService.updateDataClient(this.orden.idOrderH,r).subscribe(e=>{this.myFormGetter.phoneClient.setValue(t.phoneClient),this.myFormGetter.address.setValue(t.address),this._sweetAlertsService.alertoast("Datos actualizados.","success"),this.getOrden()})}onTopInputs(e){const t=this.myFormGetter.client.value,r={fullNameClient:t,phoneClient:this.myFormGetter.phoneClient.value,address:this.myFormGetter.address.value,nameClient:t,comments:this.myFormGetter.comments.value,documento:this.myFormGetter.document.value,referencia:this.myFormGetter.referencia.value};this._ordenService.updateDataClient(this.orden.idOrderH,r).subscribe(e=>{this._sweetAlertsService.alertoast("Datos actualizados.","success"),this.getOrden()})}newClientHandler(){this.newClient=!this.newClient}getTaxes(){this._taxesService.GetTaxes().subscribe(({response:e})=>{this.taxes=e},()=>{this._sweetAlertsService.alertoast("Error al obtener impuestos.","error")})}handleTaxes(e){const t={globaltax:e};this._ordenService.addTaxToOrder(this.orden.idOrderH,t).subscribe(()=>{this._ordenService.GetOrder(this.orden.idOrderH).subscribe(()=>{this.recarga(),0==e?this._sweetAlertsService.alertoast("Impuesto eliminado","success"):this._sweetAlertsService.alertoast("Impuesto agregado","success")},()=>{this._sweetAlertsService.alertoast("Error al obtener datos.","error")})},()=>{this._sweetAlertsService.alertoast("Error al agregar impuesto.","error")})}multiProductsToKitchen(e,t){t?this.productsToKitchen.push(e):this.productsToKitchen.find((t,r)=>{t==e&&this.productsToKitchen.splice(r,1)}),this.productsToKitchen.length>1?this.multiProductsFlag=!0:this.multiProductsFlag=!1}reprintFunctionalButton(){this._sweetAlertsService.alertoast("Debo reimprimir, en desarrollo.","success")}refundFunctionalButton(){this._sweetAlertsService.alertoast("Debo hacer devoluc\xedon, en desarrollo.","success")}creditNoteCheck(e){"4"!=localStorage.getItem("idProfile")?2==this.orden.idStatusOrder?this.orden.documento.length<1?this._sweetAlertsService.alertoast("No se pueden emitir notas de creditos con facturas sin documento.","error",6e3):o.a.fire({title:"\xbfEst\xe1 seguro que quiere generar una nota de cr\xe9dito?",text:"No podr\xe1 revertir esta acci\xf3n.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#459f47",cancelButtonColor:"#f96767",cancelButtonText:"Cancelar",confirmButtonText:"S\xed, Generar."}).then(t=>{if(t.value){this.creditNoteArr=this.fillCreditNoteArr();for(const e of this.creditNoteArr){const t=e.methodsPay,r=e.amount,i={title:`N. CR\xc9DITO PEDIDO N# ${this.orden.idOrderH} (${this.getTypePayment(t)}: ${r})`,amount:r,idUserAddFk:parseInt(localStorage.getItem("idUser")),isEntry:0,spending:0,idBranchFk:parseInt(localStorage.getItem("idBranchFk")),idCurrencyFk:1,mpCash:"mpCash"==t?r:0,mpCreditCard:"mpCreditCard"==t?r:0,mpDebitCard:"mpDebitCard"==t?r:0,mpTranferBack:"mpTranferBack"==t?r:0,mpMpago:"mpMpago"==t?r:0,mpRappi:"mpRappi"==t?r:0,mpGlovo:"mpGlovo"==t?r:0,mpUber:"mpUber"==t?r:0,mpPedidosya:"mpPedidosya"==t?r:0,mpJust:"mpJust"==t?r:0,mpWabi:"mpWabi"==t?r:0,mpOtro2:"mpOtro2"==t?r:0,mpPedidosyacash:"mpPedidosyacash"==t?r:0,mpPersonal:"mpPersonal"==t?r:0,mpRapicash:"mpRapicash"==t?r:0,mpPresent:"mpPresent"==t?r:0,mpPaypal:"mpPaypal"==t?r:0,mpZelle:"mpZelle"==t?r:0,mpBofa:"mpBofa"==t?r:0,mpYumi:"mpYumi"==t?r:0,idBoxFk:1,isCloseBox:!1};this._billingBoxService.register(i).subscribe(()=>{},()=>{this._sweetAlertsService.alertoast("No se pud\xf3 registrar la operaci\xf3n.","error")})}this._ordenService.seniatCreditNote(e).subscribe(()=>{this._ordenService.CancelOrder(e).subscribe(()=>{this._sweetAlertsService.alertoast("Nota de cr\xe9dito solicitada correctamente.","success"),this._router.navigate(["/admin/mesas/pedidos"])},()=>{this._sweetAlertsService.alertoast("Ha ocurrido un error.","error")})},()=>{this._sweetAlertsService.alertoast("Ha ocurrido un error.","error")})}}):this._sweetAlertsService.alertoast("El pedido debe estar cerrado o facturado.","error"):this._sweetAlertsService.alertoast("No est\xe1 autorizado.","error")}fillCreditNoteArr(){const{mpCash:e,mpCreditCard:t,mpDebitCard:r,mpTranferBack:i,mpMpago:s,mpRappi:o,mpGlovo:a,mpRapicash:n,mpUber:d,mpBofa:l,mpPaypal:c,mpPedidosya:h,mpPedidosyacash:u,mpPersonal:m,mpPresent:p,mpYumi:b,mpZelle:v,mpOtro2:S,mpJust:g,mpWabi:_}=this.orden;return e>0&&this.creditNoteArr.push({amount:e,methodsPay:"mpCash"}),t>0&&this.creditNoteArr.push({amount:t,methodsPay:"mpCreditCard"}),r>0&&this.creditNoteArr.push({amount:r,methodsPay:"mpDebitCard"}),i>0&&this.creditNoteArr.push({amount:i,methodsPay:"mpTranferBack"}),s>0&&this.creditNoteArr.push({amount:s,methodsPay:"mpMpago"}),o>0&&this.creditNoteArr.push({amount:o,methodsPay:"mpRappi"}),a>0&&this.creditNoteArr.push({amount:a,methodsPay:"mpGlovo"}),n>0&&this.creditNoteArr.push({amount:n,methodsPay:"mpRapicash"}),d>0&&this.creditNoteArr.push({amount:d,methodsPay:"mpUber"}),l>0&&this.creditNoteArr.push({amount:l,methodsPay:"mpBofa"}),c>0&&this.creditNoteArr.push({amount:c,methodsPay:"mpPaypal"}),h>0&&this.creditNoteArr.push({amount:h,methodsPay:"mpPedidosya"}),u>0&&this.creditNoteArr.push({amount:u,methodsPay:"mpPedidosyacash"}),m>0&&this.creditNoteArr.push({amount:m,methodsPay:"mpPersonal"}),p>0&&this.creditNoteArr.push({amount:p,methodsPay:"mpPresent"}),b>0&&this.creditNoteArr.push({amount:b,methodsPay:"mpYumi"}),v>0&&this.creditNoteArr.push({amount:v,methodsPay:"mpZelle"}),S>0&&this.creditNoteArr.push({amount:S,methodsPay:"mpOtro2"}),g>0&&this.creditNoteArr.push({amount:g,methodsPay:"mpJust"}),_>0&&this.creditNoteArr.push({amount:_,methodsPay:"mpWabi"}),this.creditNoteArr}getTypePayment(e){let t;switch(e){case"mpCash":t="E";break;case"mpCreditCard":t="C";break;case"mpDebitCard":t="D";break;case"mpTranferBack":t="T";break;case"mpMpago":t="MP";break;case"mpRappi":t="RA";break;case"mpGlovo":t="G";break;case"mpUber":t="UB";break;case"mpPedidosya":t="PEDYA";break;case"mpJust":t="EFEBOL";break;case"mpWabi":t="PMOV";break;case"mpRappi":t="RA";break;case"mpOtro2":t="OT";break;case"mpPedidosyacash":t="PEDYAE";break;case"mpPersonal":t="CPER";break;case"mpRapicash":t="RAE";break;case"mpPresent":t="R";break;case"mpPaypal":t="PAY";break;case"mpZelle":t="ZL";break;case"mpBofa":t="BO";break;case"mpYumi":t="YU"}return t}confirmKitchenAndPrint(e){null!=this._ordenService.platesSelected&&0!==this._ordenService.platesSelected.length?o.a.fire({title:"Realmente quiere enviar la comanda a caja y cocina?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#41d29d",cancelButtonColor:"#f96767",cancelButtonText:"Cancelar",confirmButtonText:"Confirmar"}).then(t=>{t.isConfirmed&&this.kitchenAndPrint(e)}):this._sweetAlertsService.alertoast("No tiene productos seleccionados","error")}kitchenAndPrint(e){this._sweetAlertsService.alertoast("Enviando impresi\xf3n, por favor espere.","success"),this.loading=!0,this._ordenService.reprint(e).subscribe(()=>{setTimeout(()=>{this._ordenService.reprintCocina(e).subscribe(()=>{this._sweetAlertsService.alertoast("Impresi\xf3n enviada a caja y cocina.","success"),this.loading=!1},()=>{this._sweetAlertsService.alertoast("Error al enviar impresi\xf3n a caja y cocina.","error")})},7e3)},()=>{this._sweetAlertsService.alertoast("Error al enviar impresi\xf3n a caja y cocina.","error")})}openSeniat(e){}nonTaxDoc(){this.loading=!0,this._ordenService.GetOrder(this._adminService.orderId?this._adminService.orderId:this.table.order[0].idOrderH).subscribe(e=>{if(this.orden=e.data,null==this.orden.body||this.orden.body.length<1)return this._sweetAlertsService.alertoast("El pedido est\xe1 vacio.","error"),void(this.loading=!1);const t={};t.header=`ORDEN #${this.orden.idOrderH}, CLIENTE: ${this.orden.fullNameClient}`;let r="";this.orden.body.forEach(({weight:e,nameProduct:t,priceSale:i})=>{r+=`${e}X ${t} $${+i*+this.dolarRate} \n \n `}),t.content=r,t.footer=`TOTAL: $${+this.TOTAL*+this.dolarRate}, ENVIO: $${null==this.orden.envio?0:+this.orden.envio*+this.dolarRate}`,t.idDocument=0,t.isPrintFiscal=1,console.log(t),this._ordenService.printNonTaxDoc(t).subscribe(e=>{console.log("resp printnontaxdoc",e),this._sweetAlertsService.alertoast("Impresi\xf3n enviada","success"),this.loading=!1},e=>{console.log("err printnontaxdoc",e),this._sweetAlertsService.alertoast("Ha ocurrido un error. Code: printnon","error"),this.loading=!1})},e=>{this._sweetAlertsService.alertoast("Error al obtener datos de la orden. Code: nontax","error"),console.log("codenontax ",e)})}reprintSeniat(e){this._ordenService.ReprintSeniat(e).subscribe(e=>{console.log(e),this._sweetAlertsService.alertoast("Reimpresi\xf3n enviada.","success")},e=>{this._sweetAlertsService.alertoast("Ha ocurrido un error al enviar impresi\xf3n Code: printCopySeniat.","error"),console.log("err printCopySeniat",e)})}printCopySeniat(e){this._ordenService.PrintCopySeniat(e).subscribe(e=>{console.log(e),this._sweetAlertsService.alertoast("Reimpresi\xf3n enviada.","success")},e=>{this._sweetAlertsService.alertoast("Ha ocurrido un error al enviar impresi\xf3n Code: printCopySeniat.","error"),console.log("err printCopySeniat",e)})}pricePDF(){if(console.log("URL logo ",i.a.apiHost+"/logo.jpg"),this.bodyList.length<1)return void this._sweetAlertsService.alertoast("Debe agregar productos.","error");const e=`${this.myDate.day}/${this.myDate.month}/${this.myDate.year}`;a.vfs=n.pdfMake.vfs;let t={content:[{columns:[{table:{widths:["*"],body:[[{image:"snow",width:170,height:60,alignment:"left",bold:!0,border:[!1,!1,!0,!1]}],[{text:"N\xfamero de orden: "+this.orden.idOrderH,alignment:"left",bold:!0,border:[!1,!1,!0,!1],color:"#010C3A"}],[{text:"Fecha: "+e,alignment:"left",bold:!0,border:[!1,!1,!0,!1],color:"#010C3A"}]]}},{table:{body:[[{text:"Cliente: "+this.orden.fullNameClient,alignment:"left",bold:!0,border:[!1,!1,!1,!1],margin:[10,0,0,5],color:"#010C3A"}],[{text:"Documento: "+(null!=this.orden.documento?this.orden.documento:"N/A"),alignment:"left",bold:!0,border:[!1,!1,!1,!1],margin:[10,5],color:"#010C3A"}],[{text:"Direcci\xf3n: "+(null!=this.orden.address?this.orden.address:"N/A"),alignment:"left",bold:!0,border:[!1,!1,!1,!1],margin:[10,5],color:"#010C3A"}],[{text:"Tel\xe9fono: "+(null!=this.orden.phoneClient?this.orden.phoneClient:"N/A"),alignment:"left",bold:!0,border:[!1,!1,!1,!1],margin:[10,5,0,15],color:"#010C3A"}]]}}]},{table:{headerRows:1,widths:[250,"*","*","*"],body:[[{text:"Producto",border:[!1,!1,!1,!1],margin:[30,8,0,8],fillColor:"#010C3A",color:"#FFFFFF"},{text:"Precio unitario",style:"tableHeader",alignment:"center",border:[!1,!1,!1,!1],margin:[0,8,0,8],fillColor:"#010C3A",color:"#FFFFFF"},{text:"Cantidad",border:[!1,!1,!1,!1],margin:[0,8,0,8],fillColor:"#010C3A",color:"#FFFFFF",alignment:"center"},{text:"Total",style:"tableHeader",alignment:"center",border:[!1,!1,!1,!1],margin:[0,8,0,8],fillColor:"#010C3A",color:"#FFFFFF"}],...this.bodyList.map(e=>[{text:e.nameProduct,margin:[30,8,0,8],border:[!1,!1,!0,!1]},{text:"$"+e.priceSale,style:"tableHeader",alignment:"center",margin:[0,8,0,8],border:[!1,!1,!0,!1]},{text:e.weight,alignment:"center",margin:[0,8,0,8],border:[!1,!1,!0,!1]},{text:"$"+e.priceProductOrder,style:"tableHeader",alignment:"center",margin:[0,8,0,8],border:[!1,!1,!1,!1]}])]},layout:{vLineColor:function(e,t){return"#010C3A"},fillColor:function(e,t,r){return e%2==0?"#F2F2F2":null}},fontSize:10}],images:{snow:i.a.apiHost+"/logo.jpg"},footer:function(){return{table:{widths:["*"],body:[[{text:"www.menusoftware.info",alignment:"center",fontSize:16,color:"#FFFFFF",fillColor:"#010C3A"}]]},layout:"noBorders",margin:[30,0],fontSize:10}}};a.createPdf(t).open()}calBsPrice(e){let t;return t=(Number(e)*Number(this.dolarRate)).toFixed(2),t}filterProducts(e){if(!e)return this.productos;const t=e.toLowerCase();return this.productos.filter(e=>e.nameProduct.toLowerCase().includes(t)||e.barCode&&e.barCode.toLowerCase().includes(t))}alert(){this._sweetAlertsService.alertoast("Debe colocar documento o n\xfamero de tel\xe9fono para enviar a cuenta","error")}}}}]);